# =============================================================================
# Model Serving CI/CD Pipeline
# =============================================================================
# Builds, tests, and deploys the model serving components
# Runs on self-hosted runners in AKS for access to internal services
# Uses Azure managed identity for ACR authentication
# =============================================================================

name: Model Serving CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'model-serving/**'
      - '.github/workflows/model-serving.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'model-serving/**'
      - '.github/workflows/model-serving.yaml'
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Image tag to deploy (leave empty for auto-generated)'
        required: false
        type: string

env:
  # ACR Configuration - update this to match your ACR
  ACR_NAME: mltrainingsdevacrqvwjyi.azurecr.io
  
  # Image names
  API_GATEWAY_IMAGE: api-gateway
  FEATURE_TRANSFORMER_IMAGE: feature-transformer
  MODEL_EXPORT_IMAGE: model-export
  BATCH_INFERENCE_IMAGE: batch-inference
  
  # Kubernetes namespaces
  SERVING_NAMESPACE: serving
  KSERVE_NAMESPACE: kserve

jobs:
  # ===========================================================================
  # Build Job - Build and push Docker images
  # ===========================================================================
  build:
    name: Build Images
    runs-on: ml-platform-runners  # Self-hosted runner in AKS
    
    outputs:
      image_tag: ${{ steps.set-tag.outputs.tag }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: |
          # if [ -n "${{ github.event.inputs.image_tag }}" ]; then
          #   TAG="${{ github.event.inputs.image_tag }}"
          # else
          #   # Generate tag from git SHA and timestamp
          #   SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          #   TIMESTAMP=$(date +%Y%m%d%H%M%S)
          #   TAG="v${TIMESTAMP}-${SHORT_SHA}"
          # fi
          # echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "tag=v20251225133814-fc5a847" >> $GITHUB_OUTPUT
          echo "Image tag: ${TAG}"

      - name: Wait for Docker daemon
        run: |
          echo "Waiting for Docker daemon to be ready..."
          timeout 60 sh -c 'until docker info > /dev/null 2>&1; do sleep 2; done'
          docker info

      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Login to ACR via Azure CLI
        run: |
          # Use managed identity from AKS node - specify kubelet identity client ID
          az login --identity --client-id 9ae25c5e-14d8-4384-9c87-a57fecb27335
          az acr login --name $(echo ${{ env.ACR_NAME }} | cut -d'.' -f1)

      - name: Build API Gateway
        working-directory: model-serving
        run: |
          docker build \
            --platform linux/amd64 \
            -t ${{ env.ACR_NAME }}/${{ env.API_GATEWAY_IMAGE }}:${{ steps.set-tag.outputs.tag }} \
            -t ${{ env.ACR_NAME }}/${{ env.API_GATEWAY_IMAGE }}:latest \
            -f api-gateway/Dockerfile \
            api-gateway/

      - name: Build Feature Transformer
        working-directory: model-serving
        run: |
          docker build \
            --platform linux/amd64 \
            -t ${{ env.ACR_NAME }}/${{ env.FEATURE_TRANSFORMER_IMAGE }}:${{ steps.set-tag.outputs.tag }} \
            -t ${{ env.ACR_NAME }}/${{ env.FEATURE_TRANSFORMER_IMAGE }}:latest \
            -f feature-transformer/Dockerfile \
            feature-transformer/

      - name: Build Model Export
        working-directory: model-serving
        run: |
          docker build \
            --platform linux/amd64 \
            -t ${{ env.ACR_NAME }}/${{ env.MODEL_EXPORT_IMAGE }}:${{ steps.set-tag.outputs.tag }} \
            -t ${{ env.ACR_NAME }}/${{ env.MODEL_EXPORT_IMAGE }}:latest \
            -f model-export/Dockerfile \
            model-export/

      - name: Build Batch Inference
        working-directory: model-serving
        run: |
          docker build \
            --platform linux/amd64 \
            -t ${{ env.ACR_NAME }}/${{ env.BATCH_INFERENCE_IMAGE }}:${{ steps.set-tag.outputs.tag }} \
            -t ${{ env.ACR_NAME }}/${{ env.BATCH_INFERENCE_IMAGE }}:latest \
            -f batch-inference/Dockerfile \
            batch-inference/

      - name: Push images
        run: |
          docker push ${{ env.ACR_NAME }}/${{ env.API_GATEWAY_IMAGE }}:${{ steps.set-tag.outputs.tag }}
          docker push ${{ env.ACR_NAME }}/${{ env.API_GATEWAY_IMAGE }}:latest
          docker push ${{ env.ACR_NAME }}/${{ env.FEATURE_TRANSFORMER_IMAGE }}:${{ steps.set-tag.outputs.tag }}
          docker push ${{ env.ACR_NAME }}/${{ env.FEATURE_TRANSFORMER_IMAGE }}:latest
          docker push ${{ env.ACR_NAME }}/${{ env.MODEL_EXPORT_IMAGE }}:${{ steps.set-tag.outputs.tag }}
          docker push ${{ env.ACR_NAME }}/${{ env.MODEL_EXPORT_IMAGE }}:latest
          docker push ${{ env.ACR_NAME }}/${{ env.BATCH_INFERENCE_IMAGE }}:${{ steps.set-tag.outputs.tag }}
          docker push ${{ env.ACR_NAME }}/${{ env.BATCH_INFERENCE_IMAGE }}:latest

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| api-gateway | ${{ steps.set-tag.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| feature-transformer | ${{ steps.set-tag.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| model-export | ${{ steps.set-tag.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| batch-inference | ${{ steps.set-tag.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Deploy to Staging
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ml-platform-runners
    needs: build
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_environment != 'production')
    
    environment:
      name: staging
      url: http://api.ml-platform.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl and envsubst
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          sudo apt-get update && sudo apt-get install -y gettext-base
          kubectl version --client
          envsubst --version

      - name: Deploy Feature Transformer
        run: |
          kubectl set image deployment/feature-transformer \
            feature-transformer=${{ env.ACR_NAME }}/${{ env.FEATURE_TRANSFORMER_IMAGE }}:${{ needs.build.outputs.image_tag }} \
            -n ${{ env.SERVING_NAMESPACE }}
          kubectl rollout status deployment/feature-transformer -n ${{ env.SERVING_NAMESPACE }} --timeout=300s

      - name: Deploy API Gateway
        working-directory: model-serving
        run: |
          export ACR_NAME=${{ env.ACR_NAME }}
          export IMAGE_TAG=${{ needs.build.outputs.image_tag }}
          envsubst < api-gateway/deployment.yaml | kubectl apply -f -
          kubectl apply -f api-gateway/istio.yaml
          kubectl rollout status deployment/api-gateway -n ${{ env.SERVING_NAMESPACE }} --timeout=300s

      - name: Wait for services to stabilize
        run: sleep 30

      - name: Deployment Summary
        run: |
          echo "## Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pod Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.SERVING_NAMESPACE }} -l "app in (api-gateway,feature-transformer)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Integration Tests
  # ===========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ml-platform-runners
    needs: [build, deploy-staging]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: |
          pip install requests pytest numpy

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client

      - name: Get Istio Ingress IP
        id: ingress
        run: |
          INGRESS_IP=$(kubectl get svc -n istio-system istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "ip=${INGRESS_IP}" >> $GITHUB_OUTPUT
          echo "Ingress IP: ${INGRESS_IP}"

      - name: Run Integration Tests
        id: tests
        working-directory: model-serving
        run: |
          # Run tests and capture output
          python tests/integration_test.py \
            --api-gateway-url http://${{ steps.ingress.outputs.ip }} \
            --host-header "api.ml-platform.example.com" \
            --api-key "test-operator-key" \
            --model-name spam-detector \
            2>&1 | tee test_output.txt
          
          # Parse results for summary
          echo "output_file=test_output.txt" >> $GITHUB_OUTPUT

      - name: Test Summary
        if: always()
        working-directory: model-serving
        run: |
          echo "## ðŸ§ª Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ needs.build.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ingress IP:** \`${{ steps.ingress.outputs.ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract test summary from output
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -f test_output.txt ]; then
            # Extract the summary section
            grep -A 20 "Test Summary" test_output.txt | head -25 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Could not parse test summary"
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Bias test results if available
          echo "### Bias Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -f test_output.txt ]; then
            grep -A 15 "Bias Test" test_output.txt | head -20 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Bias tests not run or not found"
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Accuracy metrics if available
          echo "### Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test_output.txt ]; then
            # Extract accuracy info
            ACCURACY=$(grep -oP "Accuracy:.*?[\d.]+%" test_output.txt | head -1 || echo "N/A")
            FP_RATE=$(grep -oP "False Positive.*?[\d.]+%" test_output.txt | head -1 || echo "N/A")
            FN_RATE=$(grep -oP "False Negative.*?[\d.]+%" test_output.txt | head -1 || echo "N/A")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Overall Accuracy | ${ACCURACY:-N/A} |" >> $GITHUB_STEP_SUMMARY
            echo "| False Positive Rate | ${FP_RATE:-N/A} |" >> $GITHUB_STEP_SUMMARY
            echo "| False Negative Rate | ${FN_RATE:-N/A} |" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Deploy to Production (Manual Approval Required)
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ml-platform-runners
    needs: [build, integration-tests]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_environment == 'production'
    
    environment:
      name: production
      url: http://api.ml-platform.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl and envsubst
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          sudo apt-get update && sudo apt-get install -y gettext-base
          kubectl version --client
          envsubst --version

      - name: Deploy Feature Transformer
        run: |
          kubectl set image deployment/feature-transformer \
            feature-transformer=${{ env.ACR_NAME }}/${{ env.FEATURE_TRANSFORMER_IMAGE }}:${{ needs.build.outputs.image_tag }} \
            -n ${{ env.SERVING_NAMESPACE }}
          kubectl rollout status deployment/feature-transformer -n ${{ env.SERVING_NAMESPACE }} --timeout=300s

      - name: Deploy API Gateway
        working-directory: model-serving
        run: |
          export ACR_NAME=${{ env.ACR_NAME }}
          export IMAGE_TAG=${{ needs.build.outputs.image_tag }}
          envsubst < api-gateway/deployment.yaml | kubectl apply -f -
          kubectl apply -f api-gateway/istio.yaml
          kubectl rollout status deployment/api-gateway -n ${{ env.SERVING_NAMESPACE }} --timeout=300s

      - name: Promote KServe Model to Production
        run: |
          # Update production inference service traffic
          kubectl patch inferenceservice spam-detector -n ${{ env.KSERVE_NAMESPACE }} \
            --type='merge' \
            -p '{"spec":{"predictor":{"canaryTrafficPercent":0}}}'
          
          echo "Production deployment complete!"

      - name: Production Summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.SERVING_NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
