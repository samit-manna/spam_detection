# Architecture Diagrams

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    AZURE CLOUD                                               │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                              AZURE KUBERNETES SERVICE (AKS)                              ││
│  │                                                                                          ││
│  │  ┌──────────────────────────────────────────────────────────────────────────────────┐   ││
│  │  │                                ML TRAINING                                        │   ││
│  │  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                          │   ││
│  │  │  │  Kubeflow   │───▶│    Ray      │───▶│   MLflow    │                          │   ││
│  │  │  │  Pipelines  │    │  Training   │    │  Registry   │                          │   ││
│  │  │  │  (kubeflow) │    │   (ray)     │    │  (mlflow)   │                          │   ││
│  │  │  └─────────────┘    └─────────────┘    └──────┬──────┘                          │   ││
│  │  │         │                                     │                                  │   ││
│  │  │         │              Model Export           │                                  │   ││
│  │  │         │         ┌───────────────────────────┘                                  │   ││
│  │  │         │         ▼                                                              │   ││
│  │  └─────────│─────────────────────────────────────────────────────────────────────────┘   ││
│  │            │         │                                                                   ││
│  │  ┌─────────│─────────│───────────────────────────────────────────────────────────────┐   ││
│  │  │         │         │               MODEL SERVING                                   │   ││
│  │  │         │         │                                                               │   ││
│  │  │         │         ▼                                                               │   ││
│  │  │         │  ┌─────────────┐                                                        │   ││
│  │  │         │  │   KServe    │◀────────────────────────────────────────────┐         │   ││
│  │  │         │  │  (kserve)   │                                              │         │   ││
│  │  │         │  │             │                                              │         │   ││
│  │  │         │  │  ┌───────────────────────────┐  ┌────────────────────────┐│         │   ││
│  │  │         │  │  │ spam-detector-staging     │  │ spam-detector (prod)   ││         │   ││
│  │  │         │  │  │ (min: 1, max: 3)          │  │ (min: 2, max: 10)      ││         │   ││
│  │  │         │  │  └───────────────────────────┘  └────────────────────────┘│         │   ││
│  │  │         │  └─────────────┘                                              │         │   ││
│  │  │         │         ▲                                                     │         │   ││
│  │  │         │         │                                                     │         │   ││
│  │  │         │  ┌──────┴──────┐    ┌─────────────┐    ┌─────────────┐       │         │   ││
│  │  │         │  │ API Gateway │◀───│   Feature   │    │    Feast    │       │         │   ││
│  │  │         │  │  (serving)  │    │ Transformer │    │   + Redis   │       │         │   ││
│  │  │         │  │             │───▶│  (serving)  │◀───│  (serving)  │       │         │   ││
│  │  │         │  └──────┬──────┘    └─────────────┘    └─────────────┘       │         │   ││
│  │  │         │         │                                                     │         │   ││
│  │  │         │         │ X-Environment: staging/production                   │         │   ││
│  │  │         │         │                                                     │         │   ││
│  │  └─────────│─────────│─────────────────────────────────────────────────────│─────────┘   ││
│  │            │         │                                                     │             ││
│  │  ┌─────────│─────────│─────────────────────────────────────────────────────│─────────┐   ││
│  │  │         │         │              MONITORING                             │         │   ││
│  │  │         │         │                                                     │         │   ││
│  │  │         │         │  ┌─────────────┐                                    │         │   ││
│  │  │         │         └─▶│  Inference  │─────────┐                          │         │   ││
│  │  │         │            │   Logger    │         │                          │         │   ││
│  │  │         │            └─────────────┘         │                          │         │   ││
│  │  │         │                                    │                          │         │   ││
│  │  │         │            ┌─────────────┐         │      ┌─────────────┐     │         │   ││
│  │  │         └───────────▶│  Baseline   │─────────┼─────▶│    Drift    │─────┘         │   ││
│  │  │                      │  Generator  │         │      │  Detector   │               │   ││
│  │  │                      │             │         │      │  (CronJob)  │               │   ││
│  │  │                      └─────────────┘         │      └─────────────┘               │   ││
│  │  │                            (monitoring)      │                                    │   ││
│  │  └──────────────────────────────────────────────│────────────────────────────────────┘   ││
│  │                                                 │                                        ││
│  └─────────────────────────────────────────────────│────────────────────────────────────────┘│
│                                                    │                                         │
│  ┌─────────────────────────────────────────────────│───────────────────────────────────────┐ │
│  │                           AZURE BLOB STORAGE                                            │ │
│  │                                                                                         │ │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│  │   │   models/    │  │  baselines/  │  │inference-logs│  │drift-reports/│◀─────────────│ │
│  │   │   (ONNX)     │  │   (JSON)     │  │  (Parquet)   │  │    (JSON)    │              │ │
│  │   └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│  │                                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                              │
│  ┌───────────────────────────────────┐  ┌───────────────────────────────────┐              │
│  │     AZURE CONTAINER REGISTRY      │  │          AZURE REDIS               │              │
│  │         (Docker Images)           │  │      (Feature Store Cache)         │              │
│  └───────────────────────────────────┘  └───────────────────────────────────┘              │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Request Flow

```
                                    Request Flow
                                    ════════════

    Client                API Gateway              Feature             KServe
      │                       │                   Transformer            │
      │   POST /predict       │                       │                  │
      │   X-Environment:prod  │                       │                  │
      │──────────────────────▶│                       │                  │
      │                       │                       │                  │
      │                       │   POST /transform     │                  │
      │                       │──────────────────────▶│                  │
      │                       │                       │                  │
      │                       │   features[50]        │                  │
      │                       │◀──────────────────────│                  │
      │                       │                       │                  │
      │                       │        POST /v2/models/spam-detector/infer
      │                       │─────────────────────────────────────────▶│
      │                       │                       │                  │
      │                       │        {probabilities: [0.15, 0.85]}     │
      │                       │◀─────────────────────────────────────────│
      │                       │                       │                  │
      │                       │                       │                  │
      │                       │   [async] Log to Azure Blob              │
      │                       │──────────────────────────────────────────│
      │                       │                       │                  │
      │   {prediction: spam}  │                       │                  │
      │◀──────────────────────│                       │                  │
      │                       │                       │                  │
```

## Drift Detection Flow

```
                              Drift Detection Flow
                              ════════════════════

    ┌──────────────┐          ┌──────────────┐          ┌──────────────┐
    │   Baseline   │          │   Inference  │          │    Drift     │
    │    (JSON)    │          │     Logs     │          │   Report     │
    └──────┬───────┘          └──────┬───────┘          └──────────────┘
           │                         │                          ▲
           │                         │                          │
           ▼                         ▼                          │
    ┌─────────────────────────────────────────────────────────────────┐
    │                      DRIFT DETECTOR (CronJob)                    │
    │                                                                  │
    │  1. Load baseline statistics                                     │
    │  2. Query inference logs (last 24h)                             │
    │  3. Compute PSI per feature                                      │
    │  4. Run KS-test for significance                                │
    │  5. Aggregate drift score                                        │
    │  6. Generate alerts if threshold exceeded                        │
    │  7. Save report to Azure Blob                                    │
    │                                                                  │
    └─────────────────────────────────────────────────────────────────┘

    PSI Thresholds:
    ├── < 0.1:  No drift (healthy)
    ├── 0.1-0.2: Minor drift (warning)
    └── > 0.2:  Significant drift (critical)
```

## Kubernetes Namespaces

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            KUBERNETES NAMESPACES                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   kubeflow   │  │    mlflow    │  │     ray      │  │    kserve    │    │
│  │              │  │              │  │              │  │              │    │
│  │  - Pipelines │  │  - Tracking  │  │  - Head node │  │  - Staging   │    │
│  │  - UI        │  │  - Registry  │  │  - Workers   │  │  - Production│    │
│  │              │  │              │  │              │  │              │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                      │
│  │   serving    │  │  monitoring  │  │ istio-system │                      │
│  │              │  │              │  │              │                      │
│  │  - Gateway   │  │  - Drift Job │  │  - Ingress   │                      │
│  │  - Transform │  │  - Baseline  │  │  - Mesh      │                      │
│  │  - Feast     │  │              │  │              │                      │
│  └──────────────┘  └──────────────┘  └──────────────┘                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Scaling Strategy

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            HORIZONTAL POD AUTOSCALING                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Component                    Min    Max    Metrics                         │
│  ─────────────────────────────────────────────────────────────────────────  │
│  api-gateway                   2      10    CPU: 70%, Memory: 80%           │
│  feature-transformer           2      10    CPU: 70%, Memory: 80%           │
│  spam-detector (prod)          2      10    CPU: 80%                        │
│  spam-detector-staging         1       3    CPU: 80%                        │
│                                                                              │
│                        Load Increases                                        │
│                             │                                                │
│                             ▼                                                │
│  ┌─────┐ ┌─────┐        ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐           │
│  │ Pod │ │ Pod │   ───▶ │ Pod │ │ Pod │ │ Pod │ │ Pod │ │ Pod │           │
│  └─────┘ └─────┘        └─────┘ └─────┘ └─────┘ └─────┘ └─────┘           │
│     min: 2                              max: 10                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```
